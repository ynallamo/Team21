{% extends "base.html" %}

{% block title %}{{ item.title }} Details{% endblock %}

{% block content %}
<h1>{{ item.title }}</h1>

<!-- Item Details Section -->
<div class="card" style="max-width: 600px; margin: auto;">
    <img src="{{ url_for('static', filename=item['images']) }}" class="card-img-top" alt="Item image" style="width: 100%; height: auto; max-height: 300px; object-fit: cover;">
    <div class="card-body">
        <p>{{ item.description }}</p>
        {% if item_type == 'resource' %}
            <p>Category: {{ item['category'] }}</p>
        {% elif item_type == 'community' %}
            <p>Location: {{ item['location'] }}</p>
        {% endif %}
    </div>
</div>

<!-- Owner Details Section -->
<div class="mt-4">
    <h3>Owner: {{ owner['name'] if owner['user_id'] else "Unknown" }}</h3>
    <p>Location: {{ owner['location'] if owner['user_id'] else "N/A" }}</p>
    <p>Rating: {{ average_rating if average_rating else 'No ratings yet' }}</p>
</div>

<!-- Reviews Section -->
<div class="mt-4">
    <h3>Reviews</h3>
    {% if reviews and owner['user_id'] %}
        <ul class="list-group">
            {% for review in reviews %}
                <li class="list-group-item">
                    <strong>Rating:</strong> {{ review['rating'] }} / 5
                    <p>{{ review['comment'] }}</p>
                    <small>Posted on {{ review['timestamp'] }}</small>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No reviews yet.</p>
    {% endif %}
</div>

<!-- Existing Reservations Section -->
<div class="mt-4">
    <h3>Existing Reservations</h3>
    {% if reservations %}
        <ul class="list-group">
            {% for reservation in reservations %}
                <li class="list-group-item">
                    Reserved from {{ reservation.start_date }} to {{ reservation.end_date }}
                    {% if reservation.user_id == session['user_id'] %}
                        (You reserved this)
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No reservations yet.</p>
    {% endif %}
</div>

<!-- Reservation Form -->
<div class="mt-4">
    <h3>Reserve This Item</h3>

    {% if user_reserved %}
        <p class="text-danger">You have already reserved this item. Please cancel your reservation or choose a different date range.</p>
    {% else %}
        <form method="POST" action="{{ url_for('reserve_item', item_id=item['resource_id'] if item_type == 'resource' else item['community_id']) }}">
            <div class="form-group">
                <label for="start_date">From Date:</label>
                <input type="date" class="form-control" id="start_date" name="start_date" required>
            </div>
            <div class="form-group">
                <label for="end_date">To Date:</label>
                <input type="date" class="form-control" id="end_date" name="end_date" required>
            </div>
            <button type="submit" class="btn btn-success">Reserve</button>
        </form>
    {% endif %}
</div>

<!-- Messaging Section -->
{% if owner['user_id'] %}
<div class="mt-4">
    <h3>Message the Owner</h3>
    <form method="POST" action="{{ url_for('send_message', receiver_id=owner['user_id']) }}">
        <div class="form-group">
            <textarea class="form-control" name="message_content" rows="3" placeholder="Write your message..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Send Message</button>
    </form>
</div>
{% else %}
<p class="text-muted">Messaging not available as the owner is unknown.</p>
{% endif %}
{% endblock %}
